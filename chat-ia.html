<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat IA - CultivAI</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --glass-bg: rgba(255, 255, 255, 0.72);
      --glass-border: rgba(255, 255, 255, 0.18);
      --text-primary: rgba(0, 0, 0, 0.88);
      --text-secondary: rgba(0, 0, 0, 0.56);
      --accent-green: #34C759;
      --accent-green-light: rgba(52, 199, 89, 0.12);
      --shadow-sm: 0 2px 16px rgba(0, 0, 0, 0.06);
      --shadow-md: 0 8px 32px rgba(0, 0, 0, 0.08);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .chat-container {
      width: 100%;
      max-width: 680px;
      height: 85vh;
      max-height: 800px;
      background: var(--glass-bg);
      backdrop-filter: blur(40px) saturate(180%);
      -webkit-backdrop-filter: blur(40px) saturate(180%);
      border-radius: 24px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--shadow-md);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Header */
    .chat-header {
      padding: 24px 28px;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .back-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: rgba(0, 0, 0, 0.04);
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      text-decoration: none;
      color: var(--text-primary);
    }

    .back-button:hover {
      background: rgba(0, 0, 0, 0.08);
      transform: scale(1.05);
    }

    .header-content {
      flex: 1;
    }

    .header-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.5px;
      margin-bottom: 2px;
    }

    .header-subtitle {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 400;
    }

    .ai-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent-green);
      box-shadow: 0 0 12px rgba(52, 199, 89, 0.6);
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    /* Messages Area */
    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .messages-area::-webkit-scrollbar {
      width: 6px;
    }

    .messages-area::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages-area::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.12);
      border-radius: 10px;
    }

    .message {
      display: flex;
      gap: 12px;
      animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .message.user .message-avatar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .message.assistant .message-avatar {
      background: linear-gradient(135deg, var(--accent-green) 0%, #2ecc71 100%);
    }

    .message-content {
      max-width: 70%;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .message-bubble {
      padding: 14px 18px;
      border-radius: 18px;
      font-size: 15px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .message.user .message-bubble {
      background: rgba(103, 126, 234, 0.12);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-bubble {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      color: var(--text-primary);
      border: 1px solid rgba(0, 0, 0, 0.06);
      border-bottom-left-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: var(--text-secondary);
      padding: 0 6px;
      font-weight: 500;
    }

    .message.user .message-time {
      text-align: right;
    }

    /* Loading Animation */
    .loading-dots {
      display: flex;
      gap: 4px;
      padding: 4px 0;
    }

    .loading-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent-green);
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .loading-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Input Area */
    .input-area {
      padding: 20px 28px 24px;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 0, 0, 0.06);
    }

    .input-form {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .input-wrapper {
      flex: 1;
      position: relative;
    }

    .message-input {
      width: 100%;
      padding: 14px 18px;
      border-radius: 16px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      font-size: 15px;
      font-family: inherit;
      color: var(--text-primary);
      resize: none;
      outline: none;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      max-height: 120px;
      min-height: 48px;
    }

    .message-input:focus {
      border-color: var(--accent-green);
      background: rgba(255, 255, 255, 1);
      box-shadow: 0 0 0 4px rgba(52, 199, 89, 0.08);
    }

    .message-input::placeholder {
      color: var(--text-secondary);
    }

    .send-button {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: var(--accent-green);
      color: white;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      flex-shrink: 0;
    }

    .send-button:hover {
      background: #2ecc71;
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(52, 199, 89, 0.3);
    }

    .send-button:active {
      transform: scale(0.95);
    }

    /* Empty State */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      gap: 16px;
      padding: 40px;
      text-align: center;
    }

    .empty-icon {
      font-size: 64px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .empty-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      max-width: 300px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .chat-container {
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
      }

      .message-content {
        max-width: 80%;
      }
    }  </style>
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <a href="dashboard.html" class="back-button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      </a>
      <div class="header-content">
        <div class="header-title">Asistente IA Agr√≠cola</div>
        <div class="header-subtitle">Pregunta sobre cultivos, clima y m√°s</div>
      </div>
      <div class="ai-indicator"></div>
    </div>
    <div class="messages-area" id="msgs">
      <div class="empty-state">
        <div class="empty-icon">üå±</div>
        <div class="empty-title">Hola, soy tu asistente agr√≠cola</div>
        <div class="empty-subtitle">Preg√∫ntame sobre cultivos, clima, suelo o cualquier duda sobre agricultura</div>
      </div>
    </div>
    <div class="input-area">
      <form class="input-form" id="form-chat" autocomplete="off">
        <div class="input-wrapper">
          <textarea 
            id="msg-input" 
            class="message-input"
            placeholder="Escribe tu pregunta..."
            rows="1"
            required
          ></textarea>
        </div>
        <button class="send-button" type="submit">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    const SUPABASE_URL = 'https://qjzjxcjcfjfammkyskpx.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqemp4Y2pjZmpmYW1ta3lza3B4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDk5MTMsImV4cCI6MjA3NTEyNTkxM30.dZUMwvYN_0ILfGDLK1ELneBQz-D-NCb_c6_hprESdDg';
    const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const DEEPSEEK_KEY = "sk-f2111166ca894d86a6bffdc15774999e";
    const DEEPSEEK_ENDPOINT = "https://api.deepseek.com/v1/chat/completions";
    const deviceId = localStorage.getItem('cultivai_device_id') || '';
    let chatId = null;
    let messages = [];
    let fullContext = "";

    // Auto-resize textarea
    const textarea = document.getElementById('msg-input');
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });

    async function cargarContextoTotal() {
      // Recupera historial de tests, sensores e informes para este device
      const [test, informe, sensores] = await Promise.all([
        db.from('cultivo_test_respuestas').select('*').eq('device_id', deviceId).order('created_at', {ascending:false}).limit(1).maybeSingle(),
        db.from('cultivo_informes_ai').select('*').eq('device_id', deviceId).order('fecha', {ascending:false}).limit(1).maybeSingle(),
        db.from('sensor_readings').select('*').eq('device_id', deviceId).order('created_at', {ascending:false}).limit(3)
      ]);
      fullContext = `
INFO PERSONALIZADA DEL USUARIO:

√öltimo test realizado:
${JSON.stringify(test.data||{},null,2)}

√öltimo informe generado por IA:
${JSON.stringify(informe.data||{},null,2)}

√öltimas lecturas de sensores:
${JSON.stringify((sensores.data || []),null,2)}
      `.replace(/[\n\r]+/g,"\n").slice(0,6000); // OpenAI/DeepSeek aceptan contextos amplios
    }

    async function cargarConversacion() {
      await cargarContextoTotal();
      const res = await db.from('ia_chats').select('*').eq('device_id', deviceId).order('created_at', {ascending: true}).limit(1).maybeSingle();
      if (res.data) {
        chatId = res.data.id;
        messages = res.data.messages || [];
      } else {
        const {data, error} = await db.from('ia_chats').insert([{device_id: deviceId, messages: []}]).select().single();
        chatId = data.id;
        messages = [];
      }
      pintarMensajes();
    }

    function pintarMensajes() {
      const area = document.getElementById("msgs");
      if (messages.length === 0) {
        area.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üå±</div>
            <div class="empty-title">Hola, soy tu asistente agr√≠cola</div>
            <div class="empty-subtitle">Preg√∫ntame sobre cultivos, clima, suelo o cualquier duda sobre agricultura</div>
          </div>
        `;
        return;
      }
      area.innerHTML = "";
      for (const m of messages) {
        const role = m.role === "assistant" ? "assistant" : "user";
        const avatar = role === "assistant" ? "ü§ñ" : "üë§";
        const hora = new Date(m.ts || Date.now()).toLocaleTimeString([], {hour: "2-digit", minute: "2-digit"});
        const isLoading = m.content.includes('loading-dot');
        const content = isLoading 
          ? '<div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div>'
          : m.content;
        area.innerHTML += `
          <div class="message ${role}">
            <div class="message-avatar">${avatar}</div>
            <div class="message-content">
              <div class="message-bubble">${content}</div>
              <div class="message-time">${hora}</div>
            </div>
          </div>
        `;
      }
      area.scrollTop = area.scrollHeight;
    }

    async function enviarMensaje(evt) {
      evt.preventDefault();
      const input = document.getElementById("msg-input");
      const text = input.value.trim();
      if (!text) return;
      const ts = Date.now();
      messages.push({role: "user", content: text, ts});
      pintarMensajes();
      input.value = "";
      input.style.height = 'auto';
      messages.push({role: "assistant", content: "<span class='loading-dot'></span>", ts: Date.now()});
      pintarMensajes();

      try {
        const historia = messages.filter(x => x.role === "user" || x.role === "assistant").slice(-12);
        // Manda todo el contexto personalizado a IA en cada prompt
        const iares = await fetch(DEEPSEEK_ENDPOINT, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${DEEPSEEK_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: "deepseek-chat",
            messages: [
              {
                role: "system",
                content: `
Eres el mejor asesor agr√≠cola y ganadero imaginable, tienes acceso total al historial de sensores, informes, tests, contexto personal y todo lo disponible del usuario (JSON abajo).
Conoce y aprovecha todos esos datos PERSONALIZADOS, contexto y historial en TODAS las respuestas, a menos que la pregunta no lo requiera.
Responde SIEMPRE corto (m√°x. 2-3 frases sin markdown, sin asteriscos). Escribe para que lo entienda un ni√±o peque√±o, con emojis cuando ayude. Si algo no lo sabes, di que no lo sabes.
Contexto completo del usuario:
${fullContext}
                `.trim()
              },
              ...historia.map(x => ({role: x.role, content: x.content}))
            ],
            temperature: 0.19,
            max_tokens: 220
          })
        });
        const json = await iares.json();
        messages.pop();
        let respuesta = json?.choices?.[0]?.message?.content || "No puedo responder ahora üòÖ";
        respuesta = respuesta.replace(/\*\*/g, '').replace(/\*/g, '').replace(/#{1,6}\s/g, '').replace(/`/g, '');
        messages.push({role: "assistant", content: respuesta, ts: Date.now()});
        await db.from('ia_chats').update({messages, last_message_at: new Date().toISOString()}).eq('id', chatId);
        pintarMensajes();
      } catch (e) {
        messages.pop();
        messages.push({role: "assistant", content: "No puedo responder ahora üòÖ", ts: Date.now()});
        pintarMensajes();
      }
    }

    document.getElementById('form-chat').onsubmit = enviarMensaje;
    document.addEventListener("DOMContentLoaded", cargarConversacion);
  </script>
</body>
</html>
