<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Generando informe de tus tierras | CultivAI</title>
<style>
body { 
  font-family: system-ui, sans-serif; 
  background: linear-gradient(135deg, #F8FFFC 0%, #E8F5E8 100%); 
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center; 
  min-height: 100vh;
  padding: 20px;
}
.gen-box { background: #fff; border-radius: 20px; box-shadow: 0 8px 32px rgba(34,90,53,0.12); padding: 45px 35px; min-width: 320px; max-width: 480px; width: 100%; text-align: center;}
h1 { color: #277b4d; font-size: 1.8rem; margin-bottom: 10px; font-weight: 700;}
.subtitle { color: #6b7f6b; font-size: 1.1rem; margin-bottom: 35px; font-weight: 400;}
.progressbar { width: 100%; background: #e2f5e7; border-radius: 12px; margin: 30px 0 20px 0; height: 20px; overflow: hidden; box-shadow: inset 0 2px 6px rgba(34,90,53,0.08);}
.progressbar-fill {background: linear-gradient(90deg, #277b4d 0%, #4a9960 50%, #74d179 100%);height: 100%; width: 0%; border-radius: 12px; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); position: relative; overflow: hidden;}
.progressbar-fill::after {content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite;}
@keyframes shimmer {0% { left: -100%; } 100% { left: 100%; }}
.progress-text { font-size: 0.9rem; color: #277b4d; font-weight: 600; margin-top: 8px;}
.status { margin: 25px 0; font-size: 1.15rem; color: #225a35; font-weight: 600; text-align: center; min-height: 2.5em; line-height: 1.4;}
.extrainfo { font-size: 1rem; color: #6b7f6b; text-align: center; line-height: 1.5;}
.extrainfo a {color: #277b4d; text-decoration: none; font-weight: 600; padding: 12px 24px; background: #f0f8f4; border-radius: 8px; display: inline-block; margin-top: 15px; transition: all 0.3s;}
.extrainfo a:hover {background: #277b4d; color: white; transform: translateY(-2px);}
.error { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #d32f2f;}
.loading-dots { display: inline-block; }
.loading-dots::after { content: ''; animation: dots 1.5s infinite;}
@keyframes dots {0%, 20% { content: ''; } 40% { content: '.'; } 60% { content: '..'; } 80%, 100% { content: '...'; } }
.step-indicator { display: flex; justify-content: space-between; margin: 20px 0; font-size: 0.85rem; color: #6b7f6b;}
.step { flex: 1; text-align: center; padding: 8px 4px; border-radius: 6px; transition: all 0.3s;}
.step.active { background: #e8f5e8; color: #277b4d; font-weight: 600;}
.step.completed { background: #277b4d; color: white;}
</style>
</head>
<body>
<div class="gen-box">
  <h1>Generando Informe Inteligente</h1>
  <div class="subtitle">Analizando tu parcela con IA avanzada</div>
  <div class="step-indicator">
    <div class="step" id="step1">Datos</div>
    <div class="step" id="step2">Clima</div>
    <div class="step" id="step3">Análisis</div>
    <div class="step" id="step4">IA</div>
    <div class="step" id="step5">Guardar</div>
  </div>
  <div class="progressbar">
    <div class="progressbar-fill" id="pbFill"></div>
  </div>
  <div class="progress-text" id="progressText">0%</div>
  <div class="status" id="statusTxt"><span class="loading-dots">Preparando análisis</span></div>
  <div class="extrainfo" id="msgFinal"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
// ================ CONFIGURACIÓN ================
const SUPABASE_URL = 'https://qjzjxcjcfjfammkyskpx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqemp4Y2pjZmpmYW1ta3lza3B4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1NDk5MTMsImV4cCI6MjA3NTEyNTkxM30.dZUMwvYN_0ILfGDLK1ELneBQz-D-NCb_c6_hprESdDg';
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// DeepSeek API Configuration - PON TU API KEY REAL aquí
const DEEPSEEK_KEY = 'sk-f2111166ca894d86a6bffdc15774999e'; 
const DEEPSEEK_ENDPOINT = "https://api.deepseek.com/v1/chat/completions";
const ZONA = "Cuevas del Becerro";
const COORDS = { lat: 36.9124, lon: -4.9593 };
function setProgress(p) {
  document.getElementById("pbFill").style.width = `${p}%`;
  document.getElementById("progressText").textContent = `${Math.round(p)}%`;
}
function setStatus(msg) {
  document.getElementById("statusTxt").innerHTML = `<span class="loading-dots">${msg}</span>`;
}
function setStep(stepNum) {
  for(let i = 1; i <= stepNum-1; i++) document.getElementById(`step${i}`).className = 'step completed';
  document.getElementById(`step${stepNum}`).className = 'step active';
}
function showError(msg) {
  document.getElementById('statusTxt').innerHTML = `<div class="error">Error: ${msg}</div>`;
  document.getElementById('pbFill').style.background = '#d32f2f';
}
// 1. Recuperar datos del último test del usuario
async function getUltimosDatosUsuario() {
  setProgress(5);
  setStatus("Recuperando tus respuestas del cuestionario");
  setStep(1);
  const deviceId = localStorage.getItem('cultivai_device_id');
  if (!deviceId) throw new Error("No se encontró identificador de dispositivo");
  const { data, error } = await db
    .from('cultivo_test_respuestas')
    .select('*')
    .eq('device_id', deviceId)
    .order('created_at', { ascending: false })
    .limit(1)
    .maybeSingle();
  setProgress(15);
  if (error) throw new Error(`Error base de datos: ${error.message}`);
  if (!data) throw new Error("No se encontraron respuestas recientes. Completa primero el cuestionario");
  return data;
}
// 2. Meteo real CORREGIDO
async function getClimaCuevasDelBecerro() {
  setProgress(25);
  setStatus("Consultando datos meteorológicos actualizados");
  setStep(2);
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${COORDS.lat}&longitude=${COORDS.lon}&current_weather=true&hourly=temperature_2m,relative_humidity_2m,soil_moisture_0_1cm,precipitation&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&forecast_days=7&timezone=Europe/Madrid`;
  const response = await fetch(url);
  if (!response.ok) throw new Error(`Error API meteorológica: ${response.status}`);
  setProgress(35);
  return await response.json();
}
// 3. Datos oficiales (simulado realista)
async function getDatosGobierno() {
  setProgress(45); setStatus("Consultando bases de datos oficiales"); setStep(3);
  await new Promise(r => setTimeout(r, 1500)); setProgress(55);
  return {
    "provincia": "Málaga", "comarca": "Antequera", "zonificacion": "ZONA_MEDITERRANEA_INTERIOR",
    "altitud_media": "480m",
    "cultivos_tradicionales":["olivo","trigo duro","cebada","girasol","almendro","vid","leguminosas","hortalizas de secano"],
    "cultivos_emergentes":["aguacate","frutos rojos","aromáticas","quinoa"],
    "recomendaciones_ministerio":"Fomentar rotaciones cerealísticas, mantener cubierta vegetal en olivar, optimizar uso del agua, potenciar agricultura ecológica",
    "restricciones_agua":"Consultar plan hidrológico Guadalquivir",
    "ayudas_disponibles": "PAC, ayudas agroambientales",
    "clima_tipo": "Mediterráneo continental","precipitacion_media": "450-600mm","temperatura_media":"16-18°C"
  };
}
// 4. Llamada DeepSeek
async function obtenerInformeIA(ctx) {
  setProgress(65); setStatus("Generando informe con IA DeepSeek"); setStep(4);
  const prompt = `
ANÁLISIS AGRONÓMICO - CUEVAS DEL BECERRO

Datos del agricultor:
${JSON.stringify(ctx.respuestas, null, 2)}
Datos clima:
${JSON.stringify(ctx.clima, null, 2)}
Datos oficiales:
${JSON.stringify(ctx.govdata, null, 2)}

---
Genera el informe más completo posible, explicando cada parámetro y término como si fuera para alguien sin formación (usa ejemplos y analogías tipo niños de primaria). No resumas, explica como un experto divulgador y usa todos los datos con detalle (puedes usar tantas palabras como creas razonables, ignora límites artificiales de tokens).

Devuelve solo un JSON válido así:
{
  "texto_resumido": "...",
  "recomendaciones": "...",
  "riesgos": "...",
  "cultivo_recomendado": "...",
  "rotacion_recomendada": "...",
  "acciones_adicionales": "...",
  "informe_tecnico": "...",
  "informe_agricultor": "..."
}
`;
  const response = await fetch(DEEPSEEK_ENDPOINT, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${DEEPSEEK_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      model: "deepseek-chat",
      messages: [{ role: "user", content: prompt }],
      temperature: 0.27,
      max_tokens: 8000, // SUGIERE, NO LIMITA realmente a la IA
      stream: false
    })
  });
  setProgress(85); setStatus("Procesando respuesta IA...");
  if (!response.ok) throw new Error(`Error API DeepSeek: ${response.status} - ${response.statusText}`);
  const result = await response.json();
  const contenido = result?.choices?.[0]?.message?.content;
  if (!contenido) throw new Error("Respuesta vacía de DeepSeek API");
  try { return JSON.parse(contenido); }
  catch (e) {
    return {
      texto_resumido: contenido.substring(0, 2000) + "...",
      recomendaciones: "Ver informe técnico completo",
      riesgos: "A evaluar según análisis detallado",
      cultivo_recomendado: "Consultar informe técnico",
      rotacion_recomendada: "Plan personalizado en desarrollo",
      acciones_adicionales: "Seguir recomendaciones del informe",
      informe_tecnico: contenido,
      informe_agricultor: "Consulta el informe técnico para detalles específicos"
    };
  }
}
// 5. Guardar informe en la base de datos
async function guardarInformeEnDB(ctx, informeIA) {
  setProgress(95); setStatus("Guardando informe en la base de datos"); setStep(5);
  const payload = {
    respuesta_id: ctx.respuestas.id,
    device_id: ctx.respuestas.device_id,
    user_id: ctx.respuestas.user_id,
    zona: ZONA,
    resumen_json: ctx.respuestas,
    clima_api_json: ctx.clima,
    govdata_json: ctx.govdata,
    texto_resumido: informeIA.texto_resumido || "Informe generado",
    recomendaciones: informeIA.recomendaciones || "",
    riesgos: informeIA.riesgos || "",
    cultivo_recomendado: informeIA.cultivo_recomendado || "",
    rotacion_recomendada: informeIA.rotacion_recomendada || "",
    acciones_adicionales: informeIA.acciones_adicionales || "",
    informe_tecnico: informeIA.informe_tecnico || "",
    informe_agricultor: informeIA.informe_agricultor || ""
  };
  const { data, error } = await db
    .from('cultivo_informes_ai')
    .insert([payload])
    .select()
    .single();
  if (error) throw new Error(`Error guardando informe: ${error.message}`);
  return data;
}
// FLUJO PRINCIPAL
(async function ejecutarAnalisis() {
  try {
    if (DEEPSEEK_KEY === "sk-f2111166ca894d86a6bffdc15774999e")
      throw new Error("Configura tu API key de DeepSeek en el código");
    setProgress(1); setStatus("Iniciando análisis inteligente");
    const respuestas = await getUltimosDatosUsuario();
    const clima = await getClimaCuevasDelBecerro();
    const govdata = await getDatosGobierno();
    const contexto = { respuestas, clima, govdata };
    const informeIA = await obtenerInformeIA(contexto);
    const informeGuardado = await guardarInformeEnDB(contexto, informeIA);
    setProgress(100); setStep(5);
    document.getElementById('statusTxt').innerHTML = "¡Informe generado con éxito!";
    document.getElementById('msgFinal').innerHTML = `
      <strong>Tu informe inteligente está listo</strong><br>
      <small>Informe ID: ${informeGuardado.id}</small><br>
      <a href="dashboard.html">Ver informe completo</a>
    `;
  } catch (error) {
    console.error('Error en el análisis:', error);
    showError(error.message);
    document.getElementById('msgFinal').innerHTML = `
      <div style="margin-top: 20px;">
        <a href="/test.html" style="background: #f44336; color: white;">Repetir cuestionario</a>
      </div>
    `;
  }
})();
</script>
</body>
</html>
